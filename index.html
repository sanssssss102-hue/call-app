<!DOCTYPE html>
<html>
<head>
    <title>Classroom with Balance</title>
    <script src="https://bvhrzessikgxevlaxklv.supabase.co"></script>
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; padding-top: 50px; }
        #jitsi-container { height: 100vh; width: 100vw; display: none; position: fixed; top: 0; left: 0; }
        .box { border: 1px solid #444; padding: 20px; display: inline-block; border-radius: 10px; }
        input { padding: 10px; border-radius: 5px; border: none; }
        button { padding: 10px 20px; background: #28a745; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen" class="box">
        <h2>Enter Student Email</h2>
        <input type="email" id="email" placeholder="email@example.com"><br><br>
        <button onclick="checkBalance()">Enter Classroom</button>
        <p id="status"></p>
    </div>

    <div id="jitsi-container"></div>

    <script>
        // PASTE YOUR SUPABASE INFO HERE
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function checkBalance() {
            const email = document.getElementById('email').value;
            const status = document.getElementById('status');

            // 1. Check user in Supabase
            const { data, error } = await supabase
                .from('profiles')
                .select('balance')
                .eq('email', email)
                .single();

            if (error || !data) {
                status.innerText = "User not found or no balance.";
                return;
            }

            if (data.balance <= 0) {
                status.innerText = "Insufficient balance! Please top up.";
            } else {
                status.innerText = "Balance confirmed: $" + data.balance + ". Starting call...";
                startCall(email);
                
                // 2. Deduct $10 for the lesson (Optional)
                await supabase.from('profiles').update({ balance: data.balance - 10 }).eq('email', email);
            }
        }

        function startCall(userEmail) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('jitsi-container').style.display = 'block';

            const domain = "meet.jit.si";
            const options = {
                roomName: "Class_" + new URLSearchParams(window.location.search).get('room'),
                width: "100%",
                height: "100%",
                parentNode: document.querySelector('#jitsi-container'),
                userInfo: { displayName: userEmail }
            };
            new JitsiMeetExternalAPI(domain, options);
        }
    </script>
</body>
</html>
